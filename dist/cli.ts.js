'use strict';

function _interopDefault (ex) { return (ex && (typeof ex === 'object') && 'default' in ex) ? ex['default'] : ex; }

var tslib_1 = require('tslib');
var fs = require('fs');
var path = require('path');
var sade = _interopDefault(require('sade'));
var colors = require('ansi-colors');
var prettyMs = _interopDefault(require('pretty-ms'));

var version = "0.13.1";

var _this = undefined;
var prog = sade('sapper').version(version);
prog.command('dev')
    .describe('Start a development server')
    .option('-p, --port', 'Specify a port')
    .option('-o, --open', 'Open a browser window')
    .action(function (opts) { return tslib_1.__awaiter(_this, void 0, void 0, function () {
    var dev;
    return tslib_1.__generator(this, function (_a) {
        switch (_a.label) {
            case 0: return [4 /*yield*/, Promise.resolve(require("./dev.ts.js"))];
            case 1:
                dev = (_a.sent()).dev;
                dev(opts);
                return [2 /*return*/];
        }
    });
}); });
prog.command('build [dest]')
    .describe('Create a production-ready version of your app')
    .option('-p, --port', 'Default of process.env.PORT', '3000')
    .example("build custom-dir -p 4567")
    .action(function (dest, opts) {
    if (dest === void 0) { dest = 'build'; }
    return tslib_1.__awaiter(_this, void 0, void 0, function () {
        var start, build, launcher, err_1;
        return tslib_1.__generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    console.log("> Building...");
                    process.env.NODE_ENV = process.env.NODE_ENV || 'production';
                    process.env.SAPPER_DEST = dest;
                    start = Date.now();
                    _a.label = 1;
                case 1:
                    _a.trys.push([1, 4, , 5]);
                    return [4 /*yield*/, Promise.resolve(require("./build.ts.js"))];
                case 2:
                    build = (_a.sent()).build;
                    return [4 /*yield*/, build()];
                case 3:
                    _a.sent();
                    launcher = path.resolve(dest, 'index.js');
                    fs.writeFileSync(launcher, ("\n\t\t\t\t// generated by sapper build at " + new Date().toISOString() + "\n\t\t\t\tprocess.env.NODE_ENV = process.env.NODE_ENV || 'production';\n\t\t\t\tprocess.env.SAPPER_DEST = __dirname;\n\t\t\t\tprocess.env.PORT = process.env.PORT || " + (opts.port || 3000) + ";\n\n\t\t\t\tconsole.log('Starting server on port ' + process.env.PORT);\n\t\t\t\trequire('./server.js');\n\t\t\t").replace(/^\t+/gm, '').trim());
                    console.error("\n> Finished in " + elapsed(start) + ". Type " + colors.bold.cyan("node " + dest) + " to run the app.");
                    return [3 /*break*/, 5];
                case 4:
                    err_1 = _a.sent();
                    console.error(err_1 ? err_1.details || err_1.stack || err_1.message || err_1 : 'Unknown error');
                    process.exit(1);
                    return [3 /*break*/, 5];
                case 5: return [2 /*return*/];
            }
        });
    });
});
prog.command('start [dir]')
    .describe('Start your app')
    .option('-p, --port', 'Specify a port')
    .option('-o, --open', 'Open a browser window')
    .action(function (dir, opts) {
    if (dir === void 0) { dir = 'build'; }
    return tslib_1.__awaiter(_this, void 0, void 0, function () {
        var start;
        return tslib_1.__generator(this, function (_a) {
            switch (_a.label) {
                case 0: return [4 /*yield*/, Promise.resolve(require("./start.ts.js"))];
                case 1:
                    start = (_a.sent()).start;
                    start(dir, opts);
                    return [2 /*return*/];
            }
        });
    });
});
prog.command('export [dest]')
    .describe('Export your app as static files (if possible)')
    .option('--basepath', 'Specify a base path')
    .action(function (dest, opts) {
    if (dest === void 0) { dest = 'export'; }
    return tslib_1.__awaiter(_this, void 0, void 0, function () {
        var start, build, exporter, err_2;
        return tslib_1.__generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    console.log("> Building...");
                    process.env.NODE_ENV = 'production';
                    process.env.SAPPER_DEST = '.sapper/.export';
                    start = Date.now();
                    _a.label = 1;
                case 1:
                    _a.trys.push([1, 6, , 7]);
                    return [4 /*yield*/, Promise.resolve(require("./build.ts.js"))];
                case 2:
                    build = (_a.sent()).build;
                    return [4 /*yield*/, build()];
                case 3:
                    _a.sent();
                    console.error("\n> Built in " + elapsed(start) + ". Crawling site...");
                    return [4 /*yield*/, Promise.resolve(require("./export.ts.js"))];
                case 4:
                    exporter = (_a.sent()).exporter;
                    return [4 /*yield*/, exporter(dest, opts)];
                case 5:
                    _a.sent();
                    console.error("\n> Finished in " + elapsed(start) + ". Type " + colors.bold.cyan("npx serve " + dest) + " to run the app.");
                    return [3 /*break*/, 7];
                case 6:
                    err_2 = _a.sent();
                    console.error(err_2 ? err_2.details || err_2.stack || err_2.message || err_2 : 'Unknown error');
                    process.exit(1);
                    return [3 /*break*/, 7];
                case 7: return [2 /*return*/];
            }
        });
    });
});
// TODO upgrade
prog.parse(process.argv);
function elapsed(start) {
    return prettyMs(Date.now() - start);
}
//# sourceMappingURL=cli.ts.js.map
