{"version":3,"file":"chunk-7bbecb9e.js","sources":["../src/api/build.ts"],"sourcesContent":["import * as fs from 'fs';\nimport * as path from 'path';\nimport mkdirp from 'mkdirp';\nimport rimraf from 'rimraf';\nimport { EventEmitter } from 'events';\nimport { minify_html } from './utils/minify_html';\nimport { create_compilers, create_main_manifests, create_routes, create_serviceworker_manifest } from '../core'\nimport { locations } from '../config';\nimport * as events from './interfaces';\n\nexport function build(opts: {}) {\n\tconst emitter = new EventEmitter();\n\n\texecute(emitter, opts).then(\n\t\t() => {\n\t\t\temitter.emit('done', <events.DoneEvent>{}); // TODO do we need to pass back any info?\n\t\t},\n\t\terror => {\n\t\t\temitter.emit('error', <events.ErrorEvent>{\n\t\t\t\terror\n\t\t\t});\n\t\t}\n\t);\n\n\treturn emitter;\n}\n\nasync function execute(emitter: EventEmitter, {\n\tdest = 'build',\n\tapp = 'app',\n\twebpack = 'webpack',\n\troutes = 'routes'\n} = {}) {\n\tmkdirp.sync(dest);\n\trimraf.sync(path.join(dest, '**/*'));\n\n\t// minify app/template.html\n\t// TODO compile this to a function? could be quicker than str.replace(...).replace(...).replace(...)\n\tconst template = fs.readFileSync(`${app}/template.html`, 'utf-8');\n\n\t// remove this in a future version\n\tif (template.indexOf('%sapper.base%') === -1) {\n\t\tconst error = new Error(`As of Sapper v0.10, your template.html file must include %sapper.base% in the <head>`);\n\t\terror.code = `missing-sapper-base`;\n\t\tthrow error;\n\t}\n\n\tfs.writeFileSync(`${dest}/template.html`, minify_html(template));\n\n\tconst route_objects = create_routes();\n\n\t// create app/manifest/client.js and app/manifest/server.js\n\tcreate_main_manifests({ routes: route_objects });\n\n\tconst { client, server, serviceworker } = create_compilers({ webpack });\n\n\tconst client_stats = await compile(client);\n\temitter.emit('build', <events.BuildEvent>{\n\t\ttype: 'client',\n\t\t// TODO duration/warnings\n\t\twebpack_stats: client_stats\n\t});\n\n\tconst client_info = client_stats.toJson();\n\tfs.writeFileSync(path.join(dest, 'client_info.json'), JSON.stringify(client_info));\n\tfs.writeFileSync(path.join(dest, 'client_assets.json'), JSON.stringify(client_info.assetsByChunkName));\n\n\tconst server_stats = await compile(server);\n\temitter.emit('build', <events.BuildEvent>{\n\t\ttype: 'server',\n\t\t// TODO duration/warnings\n\t\twebpack_stats: server_stats\n\t});\n\n\tlet serviceworker_stats;\n\n\tif (serviceworker) {\n\t\tcreate_serviceworker_manifest({\n\t\t\troutes: route_objects,\n\t\t\tclient_files: client_stats.toJson().assets.map((chunk: { name: string }) => `client/${chunk.name}`)\n\t\t});\n\n\t\tserviceworker_stats = await compile(serviceworker);\n\n\t\temitter.emit('build', <events.BuildEvent>{\n\t\t\ttype: 'serviceworker',\n\t\t\t// TODO duration/warnings\n\t\t\twebpack_stats: serviceworker_stats\n\t\t});\n\t}\n}\n\nfunction compile(compiler: any) {\n\treturn new Promise((fulfil, reject) => {\n\t\tcompiler.run((err: Error, stats: any) => {\n\t\t\tif (err) {\n\t\t\t\treject(err);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\n\t\t\tif (stats.hasErrors()) {\n\t\t\t\tconsole.error(stats.toString({ colors: true }));\n\t\t\t\treject(new Error(`Encountered errors while building app`));\n\t\t\t}\n\n\t\t\telse {\n\t\t\t\tfulfil(stats);\n\t\t\t}\n\t\t});\n\t});\n}\n"],"names":["EventEmitter","path.join","fs.readFileSync","fs.writeFileSync","minify_html","create_routes","create_main_manifests","create_compilers","create_serviceworker_manifest"],"mappings":"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"}